/*
 * xv6物理内存分配器深度分析 
 * =========================
 * 
 * 1. 核心数据结构分析
 * ==================
 * 
 * struct run {
 *   struct run *next;  // 指向下一个空闲页面
 * };
 * 
 * 这个设计的巧妙之处：
 * - 利用空闲页面本身存储链表节点
 * - 不需要额外的元数据存储空间
 * - 每个空闲页面的前8字节存储下一个空闲页面的地址
 * - 简单高效，内存开销极小
 * 
 * 全局状态结构：
 * struct {
 *   struct spinlock lock;  // 多核同步锁
 *   struct run *freelist;  // 空闲页面链表头
 * } kmem;
 * 
 * 2. 初始化过程分析 (kinit)
 * =======================
 * 
 * kinit() -> freerange() -> kfree()
 * 
 * 内存范围确定：
 * - 起始地址：end（内核结束地址，由链接脚本定义）
 * - 结束地址：PHYSTOP（物理内存结束地址）
 * - 页对齐：PGROUNDUP确保起始地址按页对齐
 * 
 * 链表构建过程：
 * 1. 从end开始，每4KB一个页面
 * 2. 对每个页面调用kfree()将其加入空闲链表
 * 3. kfree将页面插入链表头部（LIFO策略）
 * 
 * 为什么按页对齐？
 * - 硬件要求：页表系统要求物理地址按页对齐
 * - 简化管理：统一4KB粒度便于管理
 * - 避免碎片：减少内部碎片问题
 * 
 * 3. 分配算法分析 (kalloc)
 * =======================
 * 
 * 算法特点：
 * - 策略：LIFO（后进先出）
 * - 时间复杂度：O(1) - 常数时间分配
 * - 空间复杂度：O(1) - 无额外存储开销
 * - 线程安全：通过自旋锁保证多核安全
 * 
 * 分配流程：
 * 1. 获取自旋锁
 * 2. 取出链表头部页面
 * 3. 更新链表头指针
 * 4. 释放自旋锁
 * 5. 清零页面内容（安全考虑）
 * 
 * 4. 释放算法分析 (kfree)
 * ======================
 * 
 * 释放流程：
 * 1. 地址有效性检查（对齐、范围）
 * 2. 填充垃圾数据（检测悬空引用）
 * 3. 获取自旋锁
 * 4. 将页面插入链表头部
 * 5. 释放自旋锁
 * 
 * Double-free防护：
 * - 地址范围检查：确保地址在有效范围内
 * - 对齐检查：确保地址按页对齐
 * - 垃圾填充：memset(pa, 1, PGSIZE)有助于检测问题
 * 
 * 5. 设计优缺点分析
 * ================
 * 
 * 优点：
 * ✓ 实现简单，代码量少
 * ✓ 分配/释放都是O(1)时间复杂度
 * ✓ 内存开销极小，无外部元数据
 * ✓ 多核安全
 * 
 * 缺点：
 * ✗ 无法分配连续多页
 * ✗ 无内存使用统计
 * ✗ 无碎片整理机制
 * ✗ 无内存泄漏检测
 * ✗ LIFO可能导致缓存性能较差
 * 
 * 6. 改进思路
 * ===========
 * 
 * 内存统计扩展：
 * - 添加total_pages、free_pages、used_pages计数器
 * - 分配时递减free_pages，释放时递增
 * 
 * 内存泄漏检测：
 * - 记录每次分配的调用栈
 * - 定期扫描未释放的页面
 * - 提供内存使用报告接口
 * 
 * 更高效的分配算法：
 * - 伙伴系统：支持不同大小的连续分配
 * - slab分配器：针对小对象优化
 * - 分区管理：按用途分类管理内存
 */

#ifndef _KALLOC_H_
#define _KALLOC_H_

#include "types.h"

// 物理内存分配器接口
void pmm_init(void);              // 初始化物理内存管理器
void* alloc_page(void);           // 分配一个物理页面
void free_page(void* page);       // 释放一个物理页面
void* alloc_pages(int n);         // 分配n个连续页面（扩展功能）
uint64 get_free_pages(void);      // 获取空闲页面数量
void print_memory_stats(void);    // 打印内存使用统计

#endif // _KALLOC_H_